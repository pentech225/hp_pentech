# Google Apps Script 設定手順（詳細版）

## 📋 全体の流れ

1. Google Apps Scriptプロジェクトを作成
2. コードを貼り付け
3. テスト実行（権限承認）
4. Webアプリとしてデプロイ
5. URLを取得してHTMLに設定

---

## ステップ1: Google Apps Scriptプロジェクトの作成

1. **Google Apps Scriptにアクセス**
   - ブラウザで https://script.google.com/ を開く
   - `iteen.mukonosou@gmail.com` のアカウントでログイン

2. **新しいプロジェクトを作成**
   - 左上の「新しいプロジェクト」をクリック
   - または「+」ボタンをクリック

3. **プロジェクト名を変更**
   - 左上の「無題のプロジェクト」をクリック
   - 「iTeen 問い合わせ・予約フォーム」などに変更
   - Enterキーで確定

---

## ステップ2: コードを貼り付け

1. **既存のコードを削除**
   - エディタに表示されている `function myFunction() {}` を削除

2. **コードをコピー**
   - `google-apps-script-code.js` ファイルを開く
   - すべてのコードをコピー（Ctrl+A → Ctrl+C）

3. **エディタに貼り付け**
   - Google Apps Scriptのエディタに貼り付け（Ctrl+V）

4. **保存**
   - 左上の「保存」ボタン（💾）をクリック
   - または Ctrl+S

---

## ステップ3: テスト実行（権限承認）

### 問い合わせフォームのテスト

1. **関数を選択**
   - エディタ上部の関数選択ドロップダウンから「`testContactForm`」を選択

2. **実行ボタンをクリック**
   - 上部の「実行」ボタン（▶️）をクリック

3. **承認が必要な場合**
   - 「承認が必要です」という警告が表示されたら「承認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「iTeen 問い合わせ・予約フォーム（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

4. **実行ログを確認**
   - 下部の「実行ログ」タブで結果を確認
   - 「成功」と表示されればOK
   - メールが送信されたか確認（`iteen.mukonosou@gmail.com`の受信トレイ）

### 予約フォームのテスト

1. **関数を選択**
   - エディタ上部の関数選択ドロップダウンから「`testReservationForm`」を選択

2. **実行ボタンをクリック**
   - 上部の「実行」ボタン（▶️）をクリック

3. **実行ログを確認**
   - 下部の「実行ログ」タブで結果を確認
   - カレンダーに予約が追加されたか確認

---

## ステップ4: Webアプリとしてデプロイ

1. **デプロイメニューを開く**
   - 右上の「デプロイ」ボタンをクリック
   - 「新しいデプロイ」をクリック

2. **デプロイの種類を選択**
   - 歯車アイコン（⚙️）をクリック
   - 「種類の選択」から「ウェブアプリ」を選択

3. **設定を入力**
   - **説明**: `iTeen 問い合わせ・予約フォーム v1`（任意）
   - **次のユーザーとして実行**: 「自分」を選択
   - **アクセスできるユーザー**: 「全員」を選択（重要！）

4. **デプロイを実行**
   - 「デプロイ」ボタンをクリック

5. **承認が必要な場合**
   - 「承認が必要です」という警告が表示されたら「承認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「iTeen 問い合わせ・予約フォーム（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

6. **WebアプリのURLをコピー**
   - 「WebアプリのURL」が表示されます
   - このURLをコピー（後で使用します）
   - 例: `https://script.google.com/macros/s/AKfycbwBemLT63uE89nyfvSj7FOkgWSHLGg8CsfoPrBmv49Hqa0LHJutgGE8Y00Xrab--n7f/exec`

---

## ステップ5: HTMLファイルにURLを設定

### contact.html の設定

1. **contact.html を開く**
   - `school/mukonoso/html/contact.html` を開く

2. **URLを探す**
   - 509行目付近を探す：
   ```javascript
   const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBemLT63uE89nyfvSj7FOkgWSHLGg8CsfoPrBmv49Hqa0LHJutgGE8Y00Xrab--n7f/exec';
   ```

3. **URLを置き換え**
   - ステップ4でコピーしたURLに置き換える
   - 既存のURLを削除して、新しいURLを貼り付け

### reserve.html の設定

1. **reserve.html を開く**
   - `school/mukonoso/html/reserve.html` を開く

2. **URLを探す**
   - `GOOGLE_APPS_SCRIPT_URL` を検索（Ctrl+F）

3. **URLを置き換え**
   - ステップ4でコピーしたURLに置き換える
   - 同じURLを使用します（問い合わせフォームと予約フォームは同じスクリプトを使用）

---

## ステップ6: 動作確認

### 問い合わせフォームの確認

1. **contact.html をブラウザで開く**
   - ローカルファイルまたはサーバー上で開く

2. **フォームに入力**
   - メールアドレス: テスト用のメールアドレス
   - 電話番号: 09012345678（任意）
   - お問い合わせ内容: テストメッセージ

3. **送信ボタンをクリック**
   - 「送信する」ボタンをクリック

4. **確認**
   - 成功モーダルが表示される
   - `iteen.mukonosou@gmail.com` にメールが届く
   - 入力したメールアドレスに自動応答メールが届く

### 予約フォームの確認

1. **reserve.html をブラウザで開く**

2. **フォームに入力**
   - 学校区別、学年、日時などを選択

3. **予約を確定**
   - 「予約を確定する」ボタンをクリック

4. **確認**
   - 成功メッセージが表示される
   - `iteen.mukonosou@gmail.com` にメールが届く
   - Googleカレンダーに予約が追加される

---

## ⚠️ トラブルシューティング

### エラー: "リクエストデータが正しくありません"

**原因**: `doPost` 関数を直接実行しようとしている

**解決方法**:
- `doPost` は直接実行できません
- テストする場合は `testContactForm` または `testReservationForm` を使用
- 実際の動作確認は、WebアプリとしてデプロイしてからHTMLフォームから送信

### エラー: "Access denied" または "アクセスが拒否されました"

**原因**: アクセス権限が「全員」に設定されていない

**解決方法**:
1. 「デプロイ」→「管理デプロイ」を開く
2. 歯車アイコン（⚙️）をクリック
3. 「アクセスできるユーザー」を「全員」に変更
4. 「新しいバージョン」を作成して再デプロイ

### メールが送信されない

**確認事項**:
1. **Google Apps Scriptのログを確認**
   - エディタで「表示」→「ログ」を開く
   - エラーメッセージを確認

2. **権限の確認**
   - 初回実行時に権限を承認したか確認
   - 「デプロイ」→「管理デプロイ」で権限を確認

3. **ブラウザのコンソールを確認**
   - F12キーで開発者ツールを開く
   - 「Console」タブでエラーメッセージを確認

### CORS エラーが表示される

**原因**: `mode: 'cors'` を使用しているが、Google Apps ScriptがCORSを許可していない

**解決方法**:
- これは正常な動作です
- Google Apps ScriptはCORSを完全にはサポートしていません
- ただし、メールは正常に送信されます
- エラーが表示されても、実際には送信されている可能性があります

### カレンダーに予約が追加されない

**確認事項**:
1. **カレンダーIDの確認**
   - `google-apps-script-code.js` の `CALENDAR_ID` が正しいか確認
   - Googleカレンダーの設定からカレンダーIDを再取得

2. **カレンダーへのアクセス権限**
   - Google Apps Scriptがカレンダーにアクセスできる権限があるか確認
   - 初回実行時に権限を承認したか確認

---

## 📝 重要なポイント

1. **`doPost` は直接実行できない**
   - Webアプリとしてデプロイしてから、HTTP POSTリクエストで呼び出す必要がある
   - テストする場合は `testContactForm` または `testReservationForm` を使用

2. **アクセス権限は「全員」に設定**
   - これがないと、外部からアクセスできません

3. **初回実行時に権限を承認**
   - Gmail送信の権限
   - Googleカレンダーへのアクセス権限

4. **URLは同じものを使用**
   - 問い合わせフォームと予約フォームは同じGoogle Apps Scriptを使用
   - 同じURLを両方のHTMLファイルに設定

---

## 🔄 コードを更新した場合

1. **コードを修正**
   - Google Apps Scriptのエディタでコードを修正

2. **保存**
   - 保存ボタン（💾）をクリック

3. **再デプロイ**
   - 「デプロイ」→「管理デプロイ」を開く
   - 歯車アイコン（⚙️）をクリック
   - 「新しいバージョン」を選択
   - 「デプロイ」をクリック

4. **動作確認**
   - HTMLフォームから送信して確認

---

## 📞 サポート

問題が解決しない場合は、以下を確認してください：

1. Google Apps Scriptの実行ログ
2. ブラウザのコンソール（F12）
3. メールの受信トレイ
4. Googleカレンダーのイベント一覧

