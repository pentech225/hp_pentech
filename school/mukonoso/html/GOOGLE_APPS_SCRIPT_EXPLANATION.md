# Google Apps Scriptの仕組み - 詳しい解説

## 📚 目次

1. [Google Apps Scriptとは](#google-apps-scriptとは)
2. [デプロイとは何か](#デプロイとは何か)
3. [メール送信の仕組み](#メール送信の仕組み)
4. [なぜアクセスがはじかれるのか](#なぜアクセスがはじかれるのか)
5. [全体の流れ](#全体の流れ)

---

## Google Apps Scriptとは

**Google Apps Script（GAS）**は、Googleが提供するクラウドベースのJavaScript実行環境です。

### 特徴

- **Googleのサーバー上で実行される**
  - あなたのPCではなく、Googleのサーバーでコードが実行されます
  - 24時間365日、常に動作可能です

- **Googleサービスと連携できる**
  - Gmail（メール送信）
  - Googleカレンダー（予定の追加）
  - Googleスプレッドシート（データの保存）
  - など、多くのGoogleサービスと連携できます

- **Webアプリとして公開できる**
  - HTTPリクエスト（GET/POST）を受け付けることができます
  - 外部のWebサイトから呼び出すことができます

---

## デプロイとは何か

### デプロイの意味

**デプロイ（Deploy）**とは、**コードを実行可能な状態にして公開すること**です。

### 通常のコード実行との違い

#### ❌ エディタから直接実行（デプロイなし）

```
Google Apps Scriptエディタ
  ↓
「実行」ボタンをクリック
  ↓
あなたのGoogleアカウントで実行される
  ↓
外部からアクセスできない
```

**問題点:**
- あなたがGoogle Apps Scriptのエディタにログインしている時だけ実行できる
- 外部のWebサイト（reserve.html）からは呼び出せない
- URLが存在しない

#### ✅ Webアプリとしてデプロイ（デプロイあり）

```
Google Apps Scriptエディタ
  ↓
「デプロイ」→「新しいデプロイ」をクリック
  ↓
Webアプリとして公開
  ↓
専用のURLが生成される
  ↓
https://script.google.com/macros/s/XXXXX/exec
  ↓
外部からアクセス可能になる
```

**メリット:**
- あなたがログインしていなくても動作する
- 外部のWebサイトから呼び出せる
- 専用のURLが生成される

### デプロイの設定項目

デプロイする際に、以下の設定が必要です：

#### 1. 「次のユーザーとして実行」

- **「自分」**: あなたのGoogleアカウントの権限で実行される
  - あなたのGmailからメールが送信される
  - あなたのGoogleカレンダーに予定が追加される
- **「アクセスしているユーザー」**: アクセスした人の権限で実行される
  - 通常は「自分」を選択します

#### 2. 「アクセスできるユーザー」（重要！）

- **「自分」**: あなただけがアクセスできる
  - ❌ 外部のWebサイトからは呼び出せない
  - ❌ サインインページが表示される
- **「全員」**: 誰でもアクセスできる
  - ✅ 外部のWebサイトから呼び出せる
  - ✅ サインイン不要

**これが「アクセスがはじかれる」原因です！**

---

## メール送信の仕組み

### 全体の流れ

```
1. ユーザーが予約フォームに入力
   ↓
2. 「予約を確定する」ボタンをクリック
   ↓
3. reserve.htmlのJavaScriptが実行される
   ↓
4. fetch()でGoogle Apps ScriptのURLにPOSTリクエストを送信
   ↓
5. Google Apps ScriptのdoPost()関数が実行される
   ↓
6. GmailApp.sendEmail()でメールを送信
   ↓
7. 成功/失敗のレスポンスを返す
   ↓
8. reserve.htmlがレスポンスを受け取る
```

### 詳細な流れ

#### ステップ1: フォーム送信（reserve.html）

```javascript
// reserve.html内のコード
const emailData = {
    to: 'iteen.mukonosou@gmail.com',
    subject: '無料体験予約のお申し込み',
    child_name: '山田太郎',
    phone: '09012345678',
    // ... その他のデータ
};

// Google Apps ScriptのURLにPOSTリクエストを送信
fetch('https://script.google.com/macros/s/XXXXX/exec', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(emailData)
})
```

**何が起こるか:**
- ブラウザがGoogle Apps ScriptのURLにHTTP POSTリクエストを送信
- リクエストの本文（body）に予約データが含まれる

#### ステップ2: Google Apps Scriptがリクエストを受け取る

```javascript
// google-apps-script-code.js内のコード
function doPost(e) {
    // e.postData.contents にリクエストの本文が入っている
    const data = JSON.parse(e.postData.contents);
    
    // データを処理
    // ...
}
```

**何が起こるか:**
- Google Apps Scriptの`doPost()`関数が自動的に呼び出される
- `e.postData.contents`に送信されたデータが入っている
- JSON形式のデータをパースして使用

#### ステップ3: メール送信

```javascript
// google-apps-script-code.js内のコード
GmailApp.sendEmail(
    'iteen.mukonosou@gmail.com',  // 送信先
    '無料体験予約のお申し込み',      // 件名
    'メール本文...'                 // 本文
);
```

**何が起こるか:**
- `GmailApp.sendEmail()`が実行される
- あなたのGoogleアカウント（iteen.mukonosou@gmail.com）からメールが送信される
- **あなたのGoogleアカウントのGmailを使用するため、あなたがログインしている必要はありません**
  - デプロイ時に権限を承認していれば、自動的に送信されます

#### ステップ4: レスポンスを返す

```javascript
// google-apps-script-code.js内のコード
return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: 'メールを送信しました'
}));
```

**何が起こるか:**
- 成功/失敗の情報をJSON形式で返す
- reserve.htmlがこのレスポンスを受け取る

---

## なぜアクセスがはじかれるのか

### 原因1: 「アクセスできるユーザー」が「全員」になっていない

#### 設定が「自分」の場合

```
外部のWebサイト（reserve.html）
  ↓
Google Apps ScriptのURLにアクセス
  ↓
Googleが「誰がアクセスしているか」を確認
  ↓
「アクセスできるユーザー」が「自分」に設定されている
  ↓
「あなた（iteen.mukonosou@gmail.com）がアクセスしているか」を確認
  ↓
❌ 外部のWebサイトからは、あなたのアカウント情報が送られない
  ↓
「サインインしてください」というページが表示される
```

**解決方法:**
- 「デプロイ」→「管理デプロイ」を開く
- デプロイを編集
- 「アクセスできるユーザー」を「全員」に変更
- 新しいバージョンとして再デプロイ

#### 設定が「全員」の場合

```
外部のWebサイト（reserve.html）
  ↓
Google Apps ScriptのURLにアクセス
  ↓
Googleが「誰がアクセスしているか」を確認
  ↓
「アクセスできるユーザー」が「全員」に設定されている
  ↓
✅ 誰でもアクセス可能
  ↓
doPost()関数が実行される
```

### 原因2: デプロイされていない

コードを書いただけでは、外部からアクセスできません。

**確認方法:**
- Google Apps Scriptのエディタで「デプロイ」→「管理デプロイ」を開く
- デプロイが存在するか確認
- 存在しない場合は、新しいデプロイを作成

### 原因3: 権限が承認されていない

初回デプロイ時や、コードを変更した後は、権限の承認が必要です。

**確認方法:**
- Google Apps Scriptのエディタで「実行」→「doPost」を選択
- 「承認が必要です」という警告が表示されたら、承認する
- Gmail送信とGoogleカレンダーへのアクセス権限を許可

---

## 全体の流れ（図解）

### 正常に動作している場合

```
┌─────────────────┐
│  ユーザーのPC   │
│  (ブラウザ)     │
│                 │
│  reserve.html   │
└────────┬────────┘
         │
         │ HTTP POST リクエスト
         │ (予約データ)
         ↓
┌─────────────────────────┐
│  Google Apps Script     │
│  (Googleのサーバー)     │
│                         │
│  doPost()関数が実行     │
│  ↓                      │
│  GmailApp.sendEmail()   │
│  ↓                      │
│  メール送信             │
│  ↓                      │
│  レスポンスを返す       │
└────────┬────────────────┘
         │
         │ HTTP レスポンス
         │ (成功/失敗)
         ↓
┌─────────────────┐
│  ユーザーのPC   │
│  (ブラウザ)     │
│                 │
│  結果を表示     │
└─────────────────┘
```

### アクセスがはじかれる場合

```
┌─────────────────┐
│  ユーザーのPC   │
│  (ブラウザ)     │
│                 │
│  reserve.html   │
└────────┬────────┘
         │
         │ HTTP POST リクエスト
         │
         ↓
┌─────────────────────────┐
│  Google Apps Script     │
│                         │
│  「アクセスできるユーザー」│
│  を確認                 │
│                         │
│  ❌ 「自分」に設定されている│
│                         │
│  「サインインしてください」│
│  というページを表示     │
└─────────────────────────┘
```

---

## よくある質問

### Q1: なぜ「アクセスできるユーザー」を「全員」にしても安全なの？

**A:** セキュリティは以下の方法で確保されています：

1. **URLが秘密**
   - URLを知っている人だけがアクセスできます
   - URLは長いランダムな文字列なので、推測できません

2. **Google Apps Script側でバリデーション**
   - 送信されたデータを検証します
   - 不正なデータは拒否します

3. **レート制限**
   - Google Apps Scriptには1日の実行回数制限があります
   - 過度なアクセスは自動的に制限されます

4. **メール送信先は固定**
   - コード内で送信先が固定されているため、勝手に変更できません

### Q2: デプロイとコードの保存の違いは？

**保存:**
- コードをGoogle Apps Scriptのエディタに保存するだけ
- 外部からアクセスできない
- エディタから直接実行する場合のみ使用

**デプロイ:**
- コードを実行可能な状態にして公開する
- 外部からアクセスできるURLが生成される
- Webアプリとして使用する場合は必須

### Q3: コードを変更したら、再デプロイが必要？

**A:** はい、必要です。

- コードを変更して保存しただけでは、デプロイされたWebアプリには反映されません
- 新しいバージョンとして再デプロイする必要があります
- 「デプロイ」→「管理デプロイ」→「新しいバージョンを編集」で再デプロイ

### Q4: なぜGmailApp.sendEmail()でメールが送信できるの？

**A:** デプロイ時に権限を承認しているためです。

1. 初回デプロイ時に「承認が必要です」という警告が表示される
2. 「承認」をクリックして、Gmail送信の権限を許可する
3. これにより、Google Apps ScriptがあなたのGmailアカウントを使用してメールを送信できるようになる
4. あなたがログインしていなくても、自動的にメールが送信される

---

## まとめ

1. **デプロイ** = コードを実行可能な状態にして公開すること
2. **「アクセスできるユーザー」を「全員」に設定** = 外部からアクセス可能にする
3. **GmailApp.sendEmail()** = あなたのGoogleアカウントからメールを送信
4. **権限の承認** = 初回デプロイ時にGmail送信の権限を許可する

これらの設定が正しく行われていれば、外部のWebサイトからGoogle Apps Scriptを呼び出して、自動的にメールを送信できます。

